# PHP Redmine API

A simple PHP Object Oriented wrapper for Redmine API.

Uses [Redmine API](http://www.redmine.org/projects/redmine/wiki/Rest_api/).

## Features

* Follows PSR-4 conventions and coding standard: autoload friendly
* API entry points implementation state :
* OK Attachments
* OK Groups
* OK Custom Fields
* OK Issues
* OK Issue Categories
* OK Issue Priorities
* *NOK Issue Relations - only partially implemented*
* OK Issue Statuses
* OK News
* OK Projects
* OK Project Memberships
* OK Queries
* OK Roles
* OK Time Entries
* OK Time Entry Activities
* OK Trackers
* OK Users
* OK Versions
* OK Wiki

## Todo

* Check header's response code (especially for POST/PUT/DELETE requests)
* See http://stackoverflow.com/questions/9183178/php-curl-retrieving-response-headers-and-body-in-a-single-request/9183272#9183272
* Maybe Guzzle for handling http connections
* https://github.com/guzzle/guzzle

## Limitations

Redmine is missing some APIs for a full remote management of the data :
* List of activities & roles : http://www.redmine.org/issues/11464
* ...

A possible solution to this would be to create an extra APIs implementing the missing entry points. See existing effort in doing so : https://github.com/rschobbert/redmine-miss-api

## Requirements

* PHP ^7.3 || ^8.0
* The PHP [cURL](http://php.net/manual/en/book.curl.php) extension
* The PHP [SimpleXML](http://php.net/manual/en/book.simplexml.php) extension
* The PHP [JSON](http://php.net/manual/en/book.json.php) extension
* [PHPUnit](https://phpunit.de/) >= 9.0 (optional) to run the test suite
* "Enable REST web service" for your Redmine project (/settings/edit?tab=authentication)
* then obtain your *API access key* in your profile page : /my/account
* or use your *username & password* (not recommended)

## Install

### Composer

[Composer](http://getcomposer.org/download/) users can simply run:

```bash
$ php composer.phar require kbsali/redmine-api
```

at the root of their projects. To utilize the library, include
Composer's `vendor/autoload.php` in the scripts that will use the
`Redmine` classes.

For example,

```php
<?php
// This file is generated by Composer
require_once 'vendor/autoload.php';

$client = new Redmine\Client('http://redmine.example.com', 'username', 'password');
```

### Manual

It is also possible to install the library oneself, either locally to
a project or globally; say, in `/usr/share/php`.

Download the library from [php-download.com](https://php-download.com/package/kbsali/redmine-api). The advantage of using this site is that no Composer installation is required. This service will resolve all composer dependencies for you and create a zip archive with `vendor/autoload.php` for you.

Than extract the library somewhere. For example, the following steps extract v1.6.0 of the library into the `vendor/php-redmine-api-1.6.0` directory:

```bash
$ unzip kbsali_redmine_api_1.6.0.0_require.zip
$ rm kbsali_redmine_api_1.6.0.0_require.zip
```

Now, in any scripts that will use the `Redmine` classes, include the `vendor/autoload.php` file from the php-redmine-api directory. For
example,

```php
<?php
// This file ships with php-redmine-api
require 'vendor/php-redmine-api-1.6.0/vendor/autoload.php';

$client = new Redmine\Client('http://redmine.example.com', 'username', 'password');
```

### Running the test suite

You can run test suite to make sure the library will work properly on your system. Simply run `vendor/bin/phpunit` in the project's directory :

```
$ vendor/bin/phpunit
PHPUnit 9.5.3 by Sebastian Bergmann and contributors.

Warning:       No code coverage driver available

...............................................................  63 / 445 ( 14%)
............................................................... 126 / 445 ( 28%)
............................................................... 189 / 445 ( 42%)
............................................................... 252 / 445 ( 56%)
............................................................... 315 / 445 ( 70%)
............................................................... 378 / 445 ( 84%)
............................................................... 441 / 445 ( 99%)
....                                                            445 / 445 (100%)

Time: 00:00.102, Memory: 12.00 MB

OK (445 tests, 993 assertions)
```

## Basic usage of `php-redmine-api` client

### Start your project

Create your project e.g. in the `index.php` by require the `vendor/autoload.php` file.

```diff
+<?php
+
+require_once 'vendor/autoload.php';
```

### Instantiate a Redmine Client

You can choose between the navite curl client or the PSR-18 compatible client.

> :bulb: Since `php-redmine-api` v1.7.0 there is a new PSR-18 based client `Redmine\Client\Psr18Client`. [See this guide if you want to switch to this client.](docs/migrate-to-psr18client.md).

#### Native curl Client `Redmine\Client`

Every Client requires a URL to your Redmine instance and either a valid Apikey...

```diff
<?php

require_once 'vendor/autoload.php';
+
+// Instantiate with ApiKey
+$client = new Redmine\Client('http://localhost', '1234567890abcdfgh');
```

... or valid username/password.


```diff
<?php

require_once 'vendor/autoload.php';
+
+// Instantiate with Username/Password (not recommended)
+$client = new Redmine\Client('http://redmine.example.com', 'username', 'password');
```

> :bulb: For security reason it is recommended that you use an ApiKey rather than your username/password.

After you instantiate a client you can set some optional settings.

```diff
<?php

require_once 'vendor/autoload.php';

// Instantiate with ApiKey
$client = new Redmine\Client('https://redmine.example.com', '1234567890abcdfgh');
+
+// [OPTIONAL] if you want to check the servers' SSL certificate on Curl call
+$client->setCheckSslCertificate(true);
+
+// [OPTIONAL] set the port (it will try to guess it from the url)
+$client->setPort(8080);
+
+// [OPTIONAL] set a custom host
+$client->setCustomHost('https://localhost:8080');

```
#### Psr-18 compatible Client `Redmine\Client\Psr18Client`

The `Psr18Client` requires

- a `Psr\Http\Client\ClientInterface` implementation (like guzzlehttp/guzzle), [see](https://packagist.org/providers/psr/http-client-implementation)
- a `Psr\Http\Message\ServerRequestFactoryInterface` implementation (like nyholm/psr7), [see](https://packagist.org/providers/psr/http-factory-implementation)
- a `Psr\Http\Message\StreamFactoryInterface` implementation (like nyholm/psr7), [see](https://packagist.org/providers/psr/http-message-implementation)
- a URL to your Redmine instance
- an Apikey or username
- and optional a password if you want tu use username/password.

> :bulb: For security reason it is recommended that you use an ApiKey rather than your username/password.

```diff
<?php

require_once 'vendor/autoload.php';
+
+$guzzle = \GuzzleHttp\Client();
+$psr17Factory = new \Nyholm\Psr7\Factory\Psr17Factory();
+
+// Instantiate with ApiKey
+$client = new Redmine\Client\Prs18Client($guzzle, $psr17Factory, $psr17Factory, 'https://redmine.example.com', '1234567890abcdfgh');
+// ...or Instantiate with Username/Password (not recommended)
+$client = new Redmine\Client\Prs18Client($guzzle, $psr17Factory, $psr17Factory, 'https://redmine.example.com', 'username', 'password');
```

##### Guzzle configuration

Because the `Psr18Client` is agnostic about the HTTP client implementation every configuration specific to the transport has to be set to the `Psr\Http\Client\ClientInterface` implementation.

This means that if you want to set any `cURL` settings to `Guzzle` you have multiple ways to set them:

1. Using [Guzzle environment variables](https://docs.guzzlephp.org/en/stable/quickstart.html#environment-variables)
2. Using [request options](https://docs.guzzlephp.org/en/stable/request-options.html) inside a `Psr\Http\Client\ClientInterface` wrapper:

```diff
<?php

require_once 'vendor/autoload.php';

+use Psr\Http\Client\ClientInterface;
+use Psr\Http\Message\RequestInterface;
+use Psr\Http\Message\ResponseInterface;
+
$guzzle = \GuzzleHttp\Client();
$psr17Factory = new \Nyholm\Psr7\Factory\Psr17Factory();

+$guzzleWrapper = new class(\GuzzleHttp\Client $guzzle) implements ClientInterface
+{
+    private $guzzle;
+
+    public function __construct(\GuzzleHttp\Client $guzzle)
+    {
+        $this->guzzle = $guzzle;
+    }
+
+    public function sendRequest(RequestInterface $request): ResponseInterface
+    {
+        return $this->guzzle->send($request, [
+            // Set the options for every request here
+            'auth' => ['username', 'password', 'digest'],
+            'cert' => ['/path/server.pem', 'password'],
+            'connect_timeout' => 3.14,
+            // Set specific CURL options, see https://docs.guzzlephp.org/en/stable/faq.html#how-can-i-add-custom-curl-options
+            'curl' => [
+                CURLOPT_SSL_VERIFYPEER => 1,
+                CURLOPT_SSL_VERIFYHOST => 2,
+                CURLOPT_SSLVERSION => CURL_SSLVERSION_TLSv1_2,
+            ],
+        ]);
+    }
+};
+
// Instantiate with ApiKey
-$client = new Redmine\Client\Prs18Client($guzzle, $psr17Factory, $psr17Factory, 'https://redmine.example.com', '1234567890abcdfgh');
+$client = new Redmine\Client\Prs18Client($guzzleWrapper, $psr17Factory, $psr17Factory, 'https://redmine.example.com', '1234567890abcdfgh');

```

## Built-in Redmine features

### Impersonate User

Redmine allows you [to impersonate another user](https://www.redmine.org/projects/redmine/wiki/Rest_api#User-Impersonation). This can be done using the methods `startImpersonateUser()` and `stopImpersonateUser()`.

```php
$client->startImpersonateUser('kim');
// all requests will now impersonate the user `kim`

// To stop impersonation
$client->stopImpersonateUser();
```

### API usage

You can now use the `getApi()` method to create and get a specific Redmine API.

```php
<?php

$client->getApi('user')->all();
$client->getApi('user')->listing();

$client->getApi('issue')->create([
    'project_id'  => 'test',
    'subject'     => 'some subject',
    'description' => 'a long description blablabla',
    'assigned_to_id' => 123, // or 'assigned_to' => 'user1'
]);
$client->getApi('issue')->all([
    'limit' => 1000
]);
```

[See further examples and read more about usage in the docs](docs/usage.md).

### Thanks!

* Thanks to [Thomas Spycher](https://github.com/tspycher/) for the 1st version of the class.
* Thanks to [Thibault Duplessis aka. ornicar](https://github.com/ornicar) for the php-github-api library, great source of inspiration!
* And all the [contributors](https://github.com/kbsali/php-redmine-api/graphs/contributors)
* specially [JanMalte](https://github.com/JanMalte) for his impressive contribution to the test coverage! :)
